# Expert Review 詳細ルール

> このファイルはワークフロー（`../.agent/workflows/expert-review.md`）の補足文書。
> 通常は参照不要。判断に迷ったときだけ開く。

---

## 軽微変更の免除基準

以下のすべてを満たす場合、Expert Reviewをスキップできる:
- [ ] ロジックの変更がない（typo修正、コメント追加、README更新）
- [ ] CSSの色や余白の微調整のみ
- [ ] 新しいファイルの追加がない
- [ ] 既存のAPIやデータベースに影響しない

1つでもチェックが外れたら、最低でも第1段階（基盤ガード）を実行する。

---

## 緊急ホットフィックスモード

本番障害（サーバーダウン、データ破損、セキュリティインシデント）が発生した場合:

1. **まず直す** — Expert Reviewは後回し
2. **事後レビュー** — 修正完了後、第1段階（基盤ガード）のみ実行
3. **ログ記録** — `review-log.md` に「HOTFIX」タグで記録

---

## 重篤度別アクションルール

### 🔴 Critical
- **即時停止**。この問題を修正するまで先に進まない
- 変更がデプロイ済みなら**オジキに即報告**
- 例: API Key露出、マイグレーション漏れでデータ不整合、認証バイパス

### 🟡 Warning
- 同じタスク内で修正する
- 修正コストが大きい場合はタスクとして記録し、オジキに報告
- 例: テスト不足、N+1問題、エラーハンドリング欠如

### 🔵 Info
- `review-log.md` に記録のみ。余裕があれば対応
- 例: コード整理の余地、UX微改善、ドキュメント更新

---

## 矛盾解決の優先順序

異なる専門家の推奨が互いに矛盾した場合、以下の順序で優先する:

1. **セキュリティ** — 情報漏洩・不正アクセス防止が最優先
2. **データ整合性** — データの正確性・一貫性
3. **ユーザー体験** — オジキの使いやすさ
4. **開発効率** — コードの保守性・開発速度

優先順序で解決できない場合はオジキに判断を仰ぐ。

---

## チェック実績ログ（review-log.md）

各フル実行後、`.agent/experts/review-log.md` に追記する:

```markdown
## YYYY-MM-DD: [作業タイトル]
- **対象**: [変更したファイル/機能]
- **検出**: 🔴/🟡/🔵 #X ○○の専門家 → [指摘]（対応: 修正済/保留/却下）
- **神の目**: [主な発見]
- **改善提案（問5）**: [1つ挙げたもの]
- **実績**: [実際に問題を防いだ? YES/NO]
```

---

## 月次自己点検（毎月1日）

`review-log.md` を振り返り:
1. 各専門家の検出実績（0回なら問いかけを見直し）
2. 頻繁に検出する専門家 → 第1段階への昇格候補
3. 新たに追加すべき専門家はいるか
4. 段階の配置は適切か
5. 問5の改善提案のうち、実行すべきものはあるか

---

## 出力テンプレート

```
## 🔍 専門家チェック結果

### 📋 第0段階：変更サマリー
- **対象ファイル**: [一覧]
- **変更の種類**: [種類]
- **影響範囲**: [範囲]
- **変更の意図**: [意図]

### 第1段階：基盤ガード
- ✅ #3 バックエンドAPI → 一貫性OK
- 🟡 #4 データベース → 新カラムにindexなし
- ✅ #5 アーキテクト → 整合OK
- ✅ #11 セキュリティ → 露出なし
- 🟡 #14 テスト/QA → 削除APIにテストなし

### 第2段階：領域スキャン
- ➖ #1 UXデザイン（API変更のみ、UI無関係）
- 🔵 #6 n8nワークフロー → n8nからバッチ削除を呼ぶケースの検討
- ➖ #7〜#10, #12〜#16（該当なし）
- ✅ #25 外部API統合 → 影響なし

### 第3段階：戦略レビュー（⚡ スキーマ変更により自動発動）
- 🔵 #21 プロダクトマネージャー → ロードマップに未記載
- ➖ 他7人（該当なし）

### 🔮 第4段階：神の目
- **問1 - 盲点**: [指摘]
- **問2 - 矛盾**: [有無と解決]
- **問3 - 時間軸**: [評価]
- **問4 - 不要性**: [ROI判定]
- **問5 - 改善1点**: [具体的な1つ]（「なし」禁止）
```

---

## 専門家シリーズ正本

`.agent/experts/expert-series.md` — 25人の専門家定義。更新はここだけ行う。
