// MORODAS OS - Database Schema
// NoimosAI-inspired feed system + ã‚ªã‚¸ã‚­å°‚ç”¨æ©Ÿèƒ½ï¼ˆåç›Šãƒ»åœæ»ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

// ===========================================
// ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢é€£
// ===========================================

model Agent {
  id              String       @id @default(cuid())
  name            String       // "News Agent", "SEO Agent" etc
  type            String       // news, seo, social, geo, growth, competitor, socialmedia
  description     String?      // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®èª¬æ˜
  enabled         Boolean      @default(true)
  config          String       @default("{}") // JSONè¨­å®š
  lastRunAt       DateTime?
  
  // NoimosAIäº’æ›: è©³ç´°ãƒ‘ãƒãƒ«ç”¨
  keyCapabilities String?      // JSONé…åˆ— ["ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ", "ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ"]
  recommendedUses String?      // æ¨å¥¨ç”¨é€”ãƒ†ã‚­ã‚¹ãƒˆ
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  runs            AgentRun[]
  reports         Report[]     // ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç”Ÿæˆã—ãŸãƒ¬ãƒãƒ¼ãƒˆ
  agentTools      AgentTool[]  // é€£æºãƒ„ãƒ¼ãƒ«
  triggers        Trigger[]    // å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼
  tasks           Task[]       // å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚¿ã‚¹ã‚¯

  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model AgentRun {
  id        String   @id @default(cuid())
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  status    String   // pending, running, completed, failed
  output    String   @default("{}") // JSONå‡ºåŠ›
  error     String?  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  duration  Int?     // å®Ÿè¡Œæ™‚é–“ï¼ˆç§’ï¼‰
  prompt    String?  // ä½¿ç”¨ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆDetailè¡¨ç¤ºç”¨ï¼‰
  createdAt DateTime @default(now())
}

// ===========================================
// ãƒ„ãƒ¼ãƒ«é€£æºï¼ˆNoimosAIäº’æ›ï¼‰
// ===========================================

model Tool {
  id          String      @id @default(cuid())
  name        String      // "X (Twitter)", "Google Drive", "Slack"
  provider    String      @unique // x, google_drive, slack, youtube, facebook, notion, google_search
  icon        String?     // lucide iconå
  description String?
  isGlobal    Boolean     @default(true) // å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ä½¿ç”¨å¯èƒ½ã‹
  agentTools  AgentTool[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model AgentTool {
  id          String   @id @default(cuid())
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  toolId      String
  tool        Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  isConnected Boolean  @default(false) // é€£æºæ¸ˆã¿ã‹
  config      String   @default("{}") // ãƒ„ãƒ¼ãƒ«å›ºæœ‰è¨­å®š
  createdAt   DateTime @default(now())
  
  @@unique([agentId, toolId])
}

// ===========================================
// ãƒˆãƒªã‚¬ãƒ¼/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆNoimosAIäº’æ›ï¼‰
// ===========================================

model Trigger {
  id          String    @id @default(cuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  name        String    @default("Default Schedule")
  type        String    @default("schedule") // schedule, event, manual
  
  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
  frequency   String    @default("weekly") // daily, weekly, monthly, custom
  dayOfWeek   Int?      // 0-6 (æ—¥-åœŸ)
  dayOfMonth  Int?      // 1-31
  hour        Int       @default(9) // 0-23
  minute      Int       @default(0) // 0-59
  timezone    String    @default("Asia/Tokyo")
  
  enabled     Boolean   @default(true)
  lastFiredAt DateTime?
  nextFireAt  DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ===========================================
// ãƒ¬ãƒãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰é–¢é€£ï¼ˆNoimosAIé¢¨ï¼‰
// ===========================================

model Report {
  id          String   @id @default(cuid())
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // è¡¨ç¤ºæƒ…å ±
  title       String
  description String   // ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹æ¦‚è¦
  status      String   @default("review") // review, processing, archived, done
  
  // ãƒ¬ãƒãƒ¼ãƒˆæœ¬æ–‡ï¼ˆJSONæ§‹é€ ï¼‰
  content     String   @default("{}") // { summary, topics, insights, sns, sources }
  
  // ãƒ¡ã‚¿æƒ…å ±
  workspace   String   @default("Default Workspace")
  account     String?  // å¯¾è±¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  
  // ã‚¿ã‚¹ã‚¯é€£æº
  tasks       Task[]   // ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ===========================================
// ã‚¿ã‚¹ã‚¯ãƒ»å„ªå…ˆåº¦ç®¡ç†ï¼ˆã‚ªã‚¸ã‚­å°‚ç”¨ï¼‰
// ===========================================

model Task {
  id          String   @id @default(cuid())
  
  // ã‚¿ã‚¹ã‚¯æƒ…å ±
  title       String
  description String?
  priority    String   @default("medium") // high, medium, low
  status      String   @default("pending") // pending, in_progress, done, stagnant
  
  // æ™‚é–“æƒ…å ±
  estimatedMinutes Int?  // æ¨å®šæ‰€è¦æ™‚é–“
  dueDate     DateTime?
  completedAt DateTime?
  
  // é–¢é€£
  reportId    String?
  report      Report?  @relation(fields: [reportId], references: [id], onDelete: SetNull)
  agentType   String?  // ã©ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç”Ÿæˆã—ãŸã‹
  
  // åœæ»æ¤œçŸ¥
  lastActivityAt DateTime @default(now()) // æœ€çµ‚æ›´æ–°æ—¥æ™‚
  stagnantDays   Int      @default(0)     // åœæ»æ—¥æ•°ï¼ˆè¨ˆç®—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé€£æº
  agentId     String?
  agent       Agent?   @relation(fields: [agentId], references: [id])
  
  // GitHubé€£æºï¼ˆJulesç”¨ï¼‰
  githubIssueNumber Int?
  githubIssueUrl    String?
}

// ===========================================
// åç›Šãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼ˆã‚ªã‚¸ã‚­å°‚ç”¨ï¼‰
// ===========================================

model Revenue {
  id          String   @id @default(cuid())
  
  // åç›Šæƒ…å ±
  amount      Int      // é‡‘é¡ï¼ˆå††ï¼‰
  source      String   // note, consulting, development, other
  description String?  // èª¬æ˜
  
  // æ—¥ä»˜
  date        DateTime @default(now()) // åç›Šç™ºç”Ÿæ—¥
  
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé€£æºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  dealId      String?
  
  createdAt   DateTime @default(now())
}

// æœˆæ¬¡åç›Šã‚µãƒãƒªãƒ¼ï¼ˆé›†è¨ˆç”¨ï¼‰
model MonthlyRevenue {
  id          String   @id @default(cuid())
  
  year        Int
  month       Int
  
  // åç›Šå†…è¨³
  noteRevenue         Int @default(0)
  consultingRevenue   Int @default(0)
  developmentRevenue  Int @default(0)
  otherRevenue        Int @default(0)
  totalRevenue        Int @default(0)
  
  // ç›®æ¨™
  targetRevenue       Int @default(1000000) // ç›®æ¨™åç›Šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ100ä¸‡å††ï¼‰
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([year, month])
}

// ===========================================
// ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆKPIè¿½è·¡ï¼‰
// ===========================================

model Metric {
  id          String   @id @default(cuid())
  
  name        String   // x_followers, note_pv, note_likes, etc
  value       Int
  date        DateTime @default(now())
  
  // å¤‰åŒ–é‡
  change      Int?     // å‰å›ã‹ã‚‰ã®å¤‰åŒ–
  changePercent Float? // å¤‰åŒ–ç‡
  
  // ç›®æ¨™
  target      Int?
  
  createdAt   DateTime @default(now())
}

// ===========================================
// åœæ»ã‚¢ãƒ©ãƒ¼ãƒˆ
// ===========================================

model Alert {
  id          String   @id @default(cuid())
  
  type        String   // stagnation, deadline, revenue, system
  severity    String   @default("warning") // info, warning, critical
  
  title       String
  message     String
  
  // é–¢é€£ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
  relatedType String?  // task, report, agent
  relatedId   String?
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  isRead      Boolean  @default(false)
  isDismissed Boolean  @default(false)
  
  // è‡ªå‹•è§£æ¶ˆ
  autoResolveAt DateTime? // ã“ã®æ™‚ç‚¹ã§è‡ªå‹•è§£æ¶ˆ
  resolvedAt    DateTime?
  
  createdAt   DateTime @default(now())
}

// ===========================================
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»æ¡ˆä»¶ï¼ˆCRMï¼‰
// ===========================================

model Client {
  id          String   @id @default(cuid())
  name        String
  company     String
  email       String?
  phone       String?
  
  // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
  stage       String   @default("lead") // lead, contacted, proposal, negotiating, won, completed, lost
  
  // æ¡ˆä»¶æƒ…å ±
  dealValue   Int?     // æƒ³å®šé‡‘é¡
  probability Int?     // ç¢ºåº¦ï¼ˆ0-100%ï¼‰
  
  nextAction  String?
  dueDate     DateTime?
  notes       String?
  
  // é–¢é€£
  deals       Deal[]
  revenues    Revenue[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Deal {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  title       String?
  stage       String
  value       Int
  notes       String?
  
  closedAt    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ===========================================
// ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†
// ===========================================

model Content {
  id          String   @id @default(cuid())
  
  title       String
  platform    String   // note, x, youtube, instagram, tiktok
  type        String   @default("post") // post, thread, article, video
  status      String   @default("idea") // idea, draft, review, scheduled, published
  
  // æœ¬æ–‡
  body        String?
  
  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  scheduledAt DateTime?
  publishedAt DateTime?
  
  // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆï¼ˆJSONï¼‰
  engagement  String   @default("{}") // { views, likes, comments, shares }
  
  // ãƒ¡ãƒ¢
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ===========================================
// ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆAIè¨˜äº‹ç”Ÿæˆï¼‰
// ===========================================

model ContentIdea {
  id              String   @id @default(cuid())
  
  // ãƒã‚¿æƒ…å ±ï¼ˆn8nã‹ã‚‰å—ä¿¡ï¼‰
  title           String
  source          String?   // "TechCrunch", "HackerNews", "AI-Scholar"
  sourceUrl       String?
  angle           String?   // ç‹¬è‡ªåˆ‡ã‚Šå£
  score           Int       @default(0)  // Geminiè©•ä¾¡ã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰
  keywords        String?   // JSONé…åˆ—
  summary         String?   // ãƒã‚¿ã®è¦ç´„
  
  // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  // candidate â†’ approved â†’ generating â†’ draft â†’ publishing â†’ published â†’ rejected
  status          String    @default("candidate")
  
  // ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹
  articleBody     String?   // Markdownæœ¬æ–‡
  articleMeta     String?   // JSON (SEOãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿)
  
  // WordPressé€£æº
  wpPostId        Int?
  wpPostUrl       String?
  
  // n8né€£æº
  n8nExecutionId  String?
  
  batchDate       DateTime  @default(now())  // ã©ã®å›ã®ãƒãƒƒãƒã‹
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ===========================================
// ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
// ===========================================

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ===========================================
// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ï¼ˆAIå¯¾è©±ï¼‰
// ===========================================

model ChatSession {
  id        String    @id @default(cuid())
  title     String    @default("New Chat")
  context   String?   // Obsidian/ANTI GRAVITYé€£æºç”¨
  isActive  Boolean   @default(true)
  messages  Message[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Message {
  id        String      @id @default(cuid())
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role      String      // user, assistant, system
  content   String
  metadata  String      @default("{}") // JSONï¼ˆè¿½åŠ æƒ…å ±ï¼‰
  createdAt DateTime    @default(now())

  @@index([sessionId])
}

// ===========================================
// ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ï¼ˆWiki/Pagesï¼‰
// ===========================================

model KnowledgePage {
  id        String   @id @default(cuid())
  title     String
  content   String   @default("")
  category  String   @default("general") // general, product, marketing, technical, operations
  tags      String   @default("[]")      // JSON array of tags
  emoji     String   @default("ğŸ“„")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ===========================================
// é¢æ¥æº–å‚™ã‚·ã‚¹ãƒ†ãƒ  (Interview Prep)
// ===========================================

model InterviewCase {
  id              String   @id @default(cuid())
  title           String                  // æ¡ˆä»¶åï¼ˆä¾‹: "å–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¡ç”¨ - ç”°ä¸­å¤ªéƒ"ï¼‰
  jobPosting      String                  // æ±‚äººç¥¨ãƒ†ã‚­ã‚¹ãƒˆ
  resume          String                  // å±¥æ­´æ›¸ãƒ†ã‚­ã‚¹ãƒˆ
  personaNote     String?                 // æ±‚ã‚ã‚‹äººç‰©åƒãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰
  jobCategory     String                  // è·ç¨®ã‚«ãƒ†ã‚´ãƒª
  interviewFormat String                 // é¢æ¥å½¢å¼
  
  // AIç”Ÿæˆçµæœ
  questionSheet   String?                 // è³ªå•ã‚·ãƒ¼ãƒˆï¼ˆMarkdownï¼‰
  evaluationSheet String?                // è©•ä¾¡ã‚·ãƒ¼ãƒˆï¼ˆMarkdownï¼‰
  candidateReport String?                // å€™è£œè€…ãƒ¬ãƒãƒ¼ãƒˆï¼ˆMarkdownï¼‰
  
  // é¢æ¥å¾Œï¼ˆä»»æ„ï¼‰
  evaluationResult String?                // é¢æ¥å®˜ãŒå…¥åŠ›ã—ãŸè©•ä¾¡çµæœï¼ˆJSONï¼‰
  postReview      String?                 // AIæŒ¯ã‚Šè¿”ã‚Šã‚µãƒãƒªãƒ¼
  
  status          String   @default("draft")  // draft, generating, ready, evaluated
  
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
}
